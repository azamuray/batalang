<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>English Battle</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .fade-message {
      transition: opacity 0.5s ease;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div class="bg-white p-8 rounded-xl shadow-lg max-w-md w-full text-center">
    <h1 class="text-3xl font-bold mb-6 text-indigo-600">üß† English Battle</h1>

    <button id="find-game" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition">
      üîç –ù–∞–π—Ç–∏ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞
    </button>

    <div id="waiting" class="mt-4 text-gray-600 hidden">
      ‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...
    </div>

    <div id="game-area" class="mt-6 hidden">
      <div id="word" class="text-2xl font-semibold text-gray-800 mb-4"></div>

      <div id="translations" class="grid grid-cols-2 gap-4 mb-4"></div>

      <div id="feedback" class="fade-message text-lg font-medium mb-2 hidden"></div>

      <div id="scores" class="text-lg text-gray-700 mb-2">
        üßç‚Äç‚ôÇÔ∏è –¢—ã: <span id="your-score" class="font-bold">0</span> |
        üßç‚Äç‚ôÇÔ∏è –°–æ–ø–µ—Ä–Ω–∏–∫: <span id="opponent-score" class="font-bold">0</span>
      </div>

      <div id="game-over" class="text-xl font-bold text-indigo-700 hidden"></div>
    </div>
  </div>

  <script>
    const socket = io();
    const MAX_SCORE = 15;
    let canAnswer = true;
    let correctAnswerGlobal = null;

    document.getElementById('find-game').addEventListener('click', () => {
      socket.emit('find_game');
      document.getElementById('find-game').style.display = 'none';
      document.getElementById('waiting').style.display = 'block';
    });

    socket.on('game_start', (data) => {
      document.getElementById('waiting').style.display = 'none';
      document.getElementById('game-area').style.display = 'block';
      updateWordAndTranslations(data.word, data.translations);
    });

    socket.on('new_round', (data) => {
      updateWordAndTranslations(data.word, data.translations);
      document.getElementById('feedback').classList.add('hidden');
      canAnswer = true;
      correctAnswerGlobal = null;
    });

    socket.on('answer_result', (data) => {
      if (!canAnswer) return;

      canAnswer = false;
      document.getElementById('your-score').textContent = data.your_score;
      document.getElementById('opponent-score').textContent = data.opponent_score;
      correctAnswerGlobal = data.correct_answer;

      showFeedback(data.correct, data.correct_answer);
      styleAnswerButtons(data.correct);

      if (data.your_score >= MAX_SCORE || data.opponent_score >= MAX_SCORE) {
        endGame(data.your_score >= MAX_SCORE ? '–¢—ã –ø–æ–±–µ–¥–∏–ª!' : '–ü–æ–±–µ–¥–∏–ª —Å–æ–ø–µ—Ä–Ω–∏–∫!');
      }
    });

    socket.on('opponent_disconnected', () => {
      alert('üö´ –°–æ–ø–µ—Ä–Ω–∏–∫ –æ—Ç–∫–ª—é—á–∏–ª—Å—è. –í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.');
      resetGame();
    });

    function updateWordAndTranslations(word, translations) {
      document.getElementById('word').textContent = `üî§ ${word}`;

      const container = document.getElementById('translations');
      container.innerHTML = '';
      translations.forEach(translation => {
        const option = document.createElement('button');
        option.textContent = translation;
        option.className = 'bg-gray-200 hover:bg-gray-300 py-2 px-4 rounded-lg transition font-medium';
        option.onclick = () => {
          if (canAnswer) {
            socket.emit('answer', { answer: translation });
          }
        };
        container.appendChild(option);
      });
    }

    function styleAnswerButtons(correct) {
      const buttons = document.querySelectorAll('#translations button');
      buttons.forEach(btn => {
        btn.disabled = true;
        btn.classList.add('opacity-60');

        if (btn.textContent === correctAnswerGlobal) {
          btn.classList.add('bg-green-300');
        } else if (btn.textContent === btn.textContent && !correct) {
          btn.classList.add('bg-red-300');
        }
      });
    }

    function showFeedback(correct, answer) {
      const feedback = document.getElementById('feedback');
      feedback.textContent = correct
        ? `‚úÖ –í–µ—Ä–Ω–æ! –û—Ç–≤–µ—Ç: ${answer}`
        : `‚ùå –ù–µ–≤–µ—Ä–Ω–æ! –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: ${answer}`;
      feedback.className = `fade-message ${correct ? 'text-green-600' : 'text-red-600'}`;
      feedback.classList.remove('hidden');
      feedback.style.opacity = 1;

      setTimeout(() => {
        feedback.style.opacity = 0;
      }, 3000);
    }

    function endGame(message) {
      const gameOver = document.getElementById('game-over');
      gameOver.textContent = `üéâ ${message}`;
      gameOver.classList.remove('hidden');

      const buttons = document.querySelectorAll('#translations button');
      buttons.forEach(btn => btn.disabled = true);

      canAnswer = false;
    }

    function resetGame() {
      document.getElementById('game-area').style.display = 'none';
      document.getElementById('waiting').style.display = 'none';
      document.getElementById('find-game').style.display = 'inline-block';
      document.getElementById('your-score').textContent = '0';
      document.getElementById('opponent-score').textContent = '0';
      document.getElementById('feedback').classList.add('hidden');
      document.getElementById('game-over').classList.add('hidden');
      canAnswer = true;
    }
  </script>
</body>
</html>
